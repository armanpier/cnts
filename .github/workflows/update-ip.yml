name: Update server IP for specific ports

on:
  workflow_dispatch:
    inputs:
      new_server:
        description: 'New server IP or domain'
        required: true
        default: '127.0.0.1'

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update server field in test file
        run: |
          NEW_SERVER="${{ github.event.inputs.new_server }}"
          FILE="test"

          echo "Writing Python updater script..."
          cat << 'EOF' > update_server.py
import json, sys

new_server = sys.argv[1]
file_path = sys.argv[2]

with open(file_path, 'r', encoding='utf-8') as f:
    data = json.load(f)

def update_server(obj):
    if isinstance(obj, dict):
        if 'server' in obj and 'server_port' in obj:
            if obj['server_port'] in [45500, 30067]:
                obj['server'] = new_server
        for v in obj.values():
            update_server(v)
    elif isinstance(obj, list):
        for item in obj:
            update_server(item)

update_server(data)

with open(file_path, 'w', encoding='utf-8') as f:
    json.dump(data, f, indent=2)
EOF

          echo "Before:"
          cat "$FILE"

          echo "Running updater..."
          python3 update_server.py "$NEW_SERVER" "$FILE"

          echo "After:"
          cat "$FILE"

      - name: Commit and push changes
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Commit updated file
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git pull origin main --rebase
          git add test
          git diff --cached --quiet || git commit -m "Update server IP to ${{ github.event.inputs.new_server }}"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
